name: Dependabot Auto-merge

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-automerge:
    name: Enable auto-merge for passing Dependabot PRs
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge on Dependabot PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.workflow_run.head_sha;

            const { data: pulls } = await github.request('GET /repos/{owner}/{repo}/commits/{ref}/pulls', {
              owner,
              repo,
              ref: sha,
              mediaType: {
                previews: ['groot']
              }
            });

            const dependabotPrs = pulls.filter((pr) =>
              pr.state === 'open' && pr.user && pr.user.login === 'dependabot[bot]'
            );

            if (dependabotPrs.length === 0) {
              core.info('No open Dependabot PR is associated with this successful CI run.');
              return;
            }

            for (const pr of dependabotPrs) {
              try {
                await github.graphql(
                  `mutation($pullRequestId: ID!) {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: $pullRequestId,
                      mergeMethod: SQUASH
                    }) {
                      pullRequest {
                        number
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }`,
                  { pullRequestId: pr.node_id }
                );

                core.info(`Enabled auto-merge for Dependabot PR #${pr.number}.`);
              } catch (error) {
                core.warning(`Could not enable auto-merge for PR #${pr.number}: ${error.message}`);
              }
            }
