services:
  neo4j:
    image: neo4j:5.26
    container_name: jdeploy-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/changeit}
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p $${NEO4J_AUTH#*/} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  backend-api:
    build:
      context: .
      dockerfile: backend-api/Dockerfile
    container_name: jdeploy-backend-api
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USERNAME: ${NEO4J_USERNAME:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-changeit}
      SPRING_SECURITY_DEFAULT_USER: ${SPRING_SECURITY_DEFAULT_USER:-admin}
      SPRING_SECURITY_DEFAULT_PASSWORD: ${SPRING_SECURITY_DEFAULT_PASSWORD:-admin-change-me}
      JDEPLOY_INGEST_USER: ${JDEPLOY_INGEST_USER:-ingest}
      JDEPLOY_INGEST_PASSWORD: ${JDEPLOY_INGEST_PASSWORD:-ingest-password}
      JDEPLOY_GENERATOR_USER: ${JDEPLOY_GENERATOR_USER:-generator}
      JDEPLOY_GENERATOR_PASSWORD: ${JDEPLOY_GENERATOR_PASSWORD:-generator-password}
      JDEPLOY_READER_USER: ${JDEPLOY_READER_USER:-reader}
      JDEPLOY_READER_PASSWORD: ${JDEPLOY_READER_PASSWORD:-reader-password}

volumes:
  neo4j-data:
